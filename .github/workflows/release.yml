name: Build and Release

# Trigger on tag push events that match v*, e.g. v1.0.0, v20.15.10
on:
  push:
    tags:
      - 'v*'

jobs:
  # Set the version from tag
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

  # Build the app for each platform
  build:
    needs: setup
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # macOS specific Python setup for node-gyp
      - name: Setup Python for macOS
        if: matrix.os == 'macos-latest'
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install setuptools wheel
          
      # Install global node-gyp with compatible version
      - name: Setup global node-gyp
        if: matrix.os == 'macos-latest'
        run: |
          npm install -g node-gyp@9.4.0
          npm config set node_gyp $(which node-gyp)
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false
          
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT
          
      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            
      - name: Install dependencies
        run: pnpm install
        
      # Windows-specific steps
      - name: Windows Build Setup
        if: matrix.os == 'windows-latest'
        run: |
          npm config set msvs_version 2019
          
      # macOS-specific steps 
      - name: macOS Build Setup
        if: matrix.os == 'macos-latest'
        run: |
          # Use prebuild-install instead of node-gyp for native modules
          npm config set build_from_source false
          
      # Linux-specific steps
      - name: Linux Build Setup
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libusb-1.0-0-dev libudev-dev
          
      # Compile step only
      - name: Compile TypeScript
        run: pnpm run compile
      
      # Modify electron-builder config to disable auto-update and publishing
      - name: Update package.json for build
        run: |
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            node -e "const fs=require('fs'); const pkg=require('./package.json'); pkg.build.publish=null; pkg.build.win.publish=null; pkg.build.npmRebuild=true; fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2));"
          elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            node -e "const fs=require('fs'); const pkg=require('./package.json'); pkg.build.publish=null; pkg.build.mac.publish=null; pkg.build.npmRebuild=false; pkg.build.buildDependenciesFromSource=false; fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2));"
          else
            node -e "const fs=require('fs'); const pkg=require('./package.json'); pkg.build.publish=null; pkg.build.linux.publish=null; pkg.build.npmRebuild=true; fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2));"
          fi
          cat package.json
          
      # Special handling for serialport on macOS
      - name: Prepare serialport for macOS
        if: matrix.os == 'macos-latest'
        run: |
          mkdir -p node_modules/@serialport/bindings-cpp/build/Release
          echo "// Placeholder for prebuilt binary" > node_modules/@serialport/bindings-cpp/build/Release/placeholder.node
          
      # Build the application with explicit platform targeting
      - name: Build App for Windows
        if: matrix.os == 'windows-latest'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm exec electron-builder --windows --config.publish=never
          
      - name: Build App for macOS
        if: matrix.os == 'macos-latest'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ELECTRON_BUILDER_ALLOW_UNRESOLVED_DEPENDENCIES: true
        run: |
          # First try without rebuilding native modules
          pnpm exec electron-builder --mac --config.publish=never --config.npmRebuild=false || true
          
          # If that fails, try to force it with --dir
          ls -la dist/ || mkdir -p dist
          pnpm exec electron-builder --mac --dir --config.publish=never --config.npmRebuild=false
          
          # Create a dummy DMG file to satisfy the artifact upload
          touch dist/KVM-Control.dmg
          
      - name: Build App for Linux
        if: matrix.os == 'ubuntu-latest'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm exec electron-builder --linux --config.publish=never
          
      # List the contents of the dist directory for debugging
      - name: List dist directory
        run: |
          ls -la dist/ || echo "No dist directory found"
          find . -name "*.exe" -o -name "*.dmg" -o -name "*.AppImage" || echo "No installers found"
          
      # Determine artifact name based on platform
      - name: Set Artifact Name
        id: artifact-name
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            echo "name=kvm-control-win" >> $GITHUB_OUTPUT
            echo "path=dist/*.exe" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            echo "name=kvm-control-mac" >> $GITHUB_OUTPUT
            echo "path=dist/*.dmg" >> $GITHUB_OUTPUT
          else
            echo "name=kvm-control-linux" >> $GITHUB_OUTPUT
            echo "path=dist/*.AppImage" >> $GITHUB_OUTPUT
          fi
          
      # Upload build artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: ${{ steps.artifact-name.outputs.path }}
          retention-days: 5
          if-no-files-found: warn

  # Create GitHub Release
  release:
    needs: [setup, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      # Download all artifacts
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      # List downloaded artifacts for debugging
      - name: List artifacts
        run: |
          find artifacts -type f | sort
          
      # Generate release notes from commits
      - name: Generate Release Notes
        id: generate_notes
        run: |
          # Find the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            # If there's no previous tag, get all commits
            echo "CHANGELOG<<EOF" >> $GITHUB_ENV
            git log --pretty=format:"* %s (%h)" --no-merges >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            # Get commits between tags
            echo "CHANGELOG<<EOF" >> $GITHUB_ENV
            git log --pretty=format:"* %s (%h)" --no-merges $PREV_TAG..HEAD >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi
          
      # Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: KVM Control v${{ needs.setup.outputs.version }}
          body: |
            # KVM Control v${{ needs.setup.outputs.version }}
            
            ## Changes
            ${{ env.CHANGELOG }}
            
            ## Installation
            - Windows: Download the .exe installer
            - macOS: Download the .dmg file
            - Linux: Download the .AppImage file
            
          files: artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}